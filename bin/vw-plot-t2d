#!/bin/bash

function usage()
{
    echo "Usage: `basename $0` [-d graph_dir] [-o output_type] -l log_id1 [tag1 tag2 tag3]"
    echo "       `basename $0` -?"
    echo
    echo "      -d graph_dir    Directory in which to produce plotting data."
    echo "                      Default is \$WORKSPACE_VAR/graphs/avg_duration/\$GRAPH_NAME"
    echo "                      where \$GRAPH_NAME is generated based on the log ids"
    echo "      -o output_type  Besides generating the GNUPlot file, use GNUPlot to generate"
    echo "                      a file of type <output_type> (called 'graph.<output_type>')"
    echo "                      Valid types are png, jpg, pdf, and eps."
    echo "      -l log_id       Log identifier to analyze"
    echo "      -?              Prints this usage message"
    echo
}



#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~ BASIC SANITY CHECKS ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#

if [ "$WORKSPACE_DIR" == "" ];
then
    echo "WORKSPACE_DIR not set."
    exit 1
fi

if [ "$WORKSPACE_VAR" == "" ];
then
    echo "WORKSPACE_VAR not set."
    exit 1
fi

if [ $# -eq 0 ];
then
    echo "ERROR: No arguments specified!"
    usage
    exit 1
fi

# Error on unset variables
set -u




#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ GET OPTIONS ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#

# Defaults
GRAPH_DIR=""
OUTPUT_TYPE=""
LOG_ID=""

# Get options
while getopts ":d:o:l:?" OPTION; do
    case $OPTION in
        d )
            GRAPH_DIR=$OPTARG
	;;
        o )
            OUTPUT_TYPE=$OPTARG
        ;;
        l )
            LOG_ID=$OPTARG
        ;;
        \? )
            usage
            exit 1
        ;;
        * )
            echo "ERROR: Unrecognized option"
            exit 1
        ;;
    esac
done

shift `expr $OPTIND - 1`

if [ $# -eq 0 ];
then
    echo "ERROR: Must specify at least one tag"
    usage
    exit 1
fi

if [ "$GRAPH_DIR" == "" ];
then
    GRAPH_DIR=$WORKSPACE_VAR/graphs/t2dsingle_$LOG_ID
fi


# Generate average counts

mkdir -p $GRAPH_DIR

for TAG in $@;
do
    vw-log-t2d -l $LOG_ID -o $GRAPH_DIR/t2d_${LOG_ID}_$TAG.dat -t $TAG
done


# Generate GNUPlot file

I=1

echo "set xlabel \"Time (s)\"" > $GRAPH_DIR/t2d.plot
echo "set ylabel \"T2D ratio\"" >> $GRAPH_DIR/t2d.plot
echo "plot \\" >> $GRAPH_DIR/t2d.plot
for TAG in $@;
do
    echo -n "\"t2d_${LOG_ID}_$TAG.dat\" using 1:2 t \"Tag: $TAG ($LOG_ID)\" lt $I pt 2 with points" >> $GRAPH_DIR/t2d.plot
    if [ $I -lt $# ];
    then
	echo ",\\" >> $GRAPH_DIR/t2d.plot
    fi 
    I=$((I+1))
done

if [ "$OUTPUT_TYPE" != "" ];
then
    echo "set output \"$GRAPH_DIR/graph.$OUTPUT_TYPE\"" > $GRAPH_DIR/t2d_$OUTPUT_TYPE.plot.tmp
    echo "set terminal $OUTPUT_TYPE" >> $GRAPH_DIR/t2d_$OUTPUT_TYPE.plot.tmp
    cat $GRAPH_DIR/t2d_$OUTPUT_TYPE.plot.tmp $GRAPH_DIR/t2d.plot > $GRAPH_DIR/t2d_$OUTPUT_TYPE.plot
    rm $GRAPH_DIR/t2d_$OUTPUT_TYPE.plot.tmp
    cd $GRAPH_DIR
    gnuplot t2d_$OUTPUT_TYPE.plot
fi