#!/bin/bash

# Mock VW execution script
# Not meant to be invoked directly

function usage()
{
    echo "Usage: `basename $0` [-h hostfile] -l log_id -d duration -i image -c config -t"
    echo "       `basename $0` -?"
    echo
    echo "	-l log_id       Log identifier (determines name of log files)"
    echo "	                Default is 'TEST'"
    echo "	-h hostfile     \$pe_hostfile"
    echo "	-?              Prints this usage message"
    echo
}



#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~ BASIC SANITY CHECKS ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#

if [ "$WORKSPACE_DIR" == "" ];
then
    echo "WORKSPACE_DIR not set."
    exit 1
fi

if [ "$WORKSPACE_VAR" == "" ];
then
    echo "WORKSPACE_VAR not set."
    exit 1
fi

if [ "$JOB_ID" == "" ];
then
    JOB_ID=0
fi

if [ "$SGE_TASK_ID" == "" ];
then
    SGE_TASK_ID=0
fi

if [ "$JOB_NAME" == "" ];
then
    JOB_NAME="NULL"
fi

if [ $# -eq 0 ];
then
    echo "ERROR: No arguments specified!"
    usage
    exit 1
fi

source "$WORKSPACE_DIR/bin/common.sh"

# Error on unset variables
set -u




#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ GET OPTIONS ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#

# Defaults
LOG_ID="TEST"
TAG="NULL"
HOSTFILE="/var/workspace/global/hostfiles/${JOB_ID}ar"
RUN=true

# Get options
while getopts "c:ti:l:d:h:?" OPTION; do
    case $OPTION in
	l ) 
	    LOG_ID=$OPTARG
	;;
	h ) 
	    HOSTFILE=$OPTARG
	;;
	d ) 
	    DURATION=$OPTARG
	;;
	i ) 
	    IMAGE=$OPTARG
            IMG_ID=`echo $IMAGE | rev | cut -f1 -d/ | rev`
	;;
	c ) 
	    CONFIG=$OPTARG
	;;
	t ) 
	    RUN=false
	;;
	\? ) 
	    usage
	    exit 1
	;;
	* ) 
	    echo "ERROR: Unrecognized option"
	    exit 1
	;;
    esac
done



#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~ MAIN CODE BEGINS HERE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#

ERROR=0

BANNER="job_name=$JOB_NAME, job_id=$JOB_ID, task_id=$SGE_TASK_ID"

log "--VWRUN_START--"

IMGNUMBER=1
for HOST in $(cat $HOSTFILE);
do
    log "Starting VM in $HOST"
    if $RUN;
    then
	qrsh -inherit -V $HOST $WORKSPACE_DIR/bin/vw-vm-start -i $IMG_ID.$JOB_ID.$IMGNUMBER -l $LOG_ID
    else
	echo qrsh -inherit -V $HOST $WORKSPACE_DIR/bin/vw-vm-start -i $IMG_ID.$JOB_ID.$IMGNUMBER -l $LOG_ID
    fi
    IMGNUMBER=$(($IMGNUMBER +1))
done

# Do something (sleep)
if $RUN;
then
    sleep $DURATION
fi

IMGNUMBER=1
for HOST in $(cat $HOSTFILE);
do
    log "Stopping VM in $HOST"
    if $RUN;
    then
	qrsh -inherit -V $HOST $WORKSPACE_DIR/bin/vw-vm-stop -i $IMG_ID.$JOB_ID.$IMGNUMBER -l $LOG_ID
    else
	echo qrsh -inherit -V $HOST $WORKSPACE_DIR/bin/vw-vm-stop -i $IMG_ID.$JOB_ID.$IMGNUMBER -l $LOG_ID
    fi
    IMGNUMBER=$(($IMGNUMBER +1))
done

log "--VWRUN_END--"
