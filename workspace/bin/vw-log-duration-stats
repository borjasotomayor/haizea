#!/bin/bash

function usage()
{
    echo "Usage: `basename $0` -l log_id -b begin_event -e end_event [-o output]"
    echo "       `basename $0` -?"
    echo
    echo "      -l log_id       Log identifier (only count events from log files"
    echo "                      with this identifier)"
    echo "      -b begin_event  Start event"
    echo "      -e end_event    End event"
    echo "      -o output       Print results to file <output>"
    echo "      -?              Prints this usage message"
    echo
}



#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~ BASIC SANITY CHECKS ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#

if [ "$WORKSPACE_DIR" == "" ];
then
    echo "WORKSPACE_DIR not set."
    exit 1
fi

if [ "$WORKSPACE_VAR" == "" ];
then
    echo "WORKSPACE_VAR not set."
    exit 1
fi

if [ $# -eq 0 ];
then
    echo "ERROR: No arguments specified!"
    usage
    exit 1
fi

# Error on unset variables
set -u




#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ GET OPTIONS ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#

# Defaults
LOG_ID=""
BEGIN_EVENT=""
END_EVENT=""
OUTPUT=""

# Get options
while getopts ":l:b:e:o:?" OPTION; do
    case $OPTION in
        l )
            LOG_ID=$OPTARG
        ;;
        b )
            BEGIN_EVENT=$OPTARG
        ;;
        e )
            END_EVENT=$OPTARG
        ;;
        o )
            OUTPUT=$OPTARG
        ;;
        \? )
            usage
            exit 1
        ;;
        * )
            echo "ERROR: Unrecognized option"
            exit 1
        ;;
    esac
done

if [ "$LOG_ID" == "" ];
then
    echo "ERROR: No log identifier specified."
    usage
    exit 1
fi
if [ "$BEGIN_EVENT" == "" ] || [ "$END_EVENT" == "" ];
then
    echo "ERROR: No begin or end event name specified."
    usage
    exit 1
fi

if [ "$OUTPUT" == "" ];
then
    sort $WORKSPACE_VAR/logs/*_${LOG_ID}_*.log | awk  -f $WORKSPACE_DIR/lib/duration-stats.awk beginEvent="$BEGIN_EVENT" endEvent="$END_EVENT"
else
    sort $WORKSPACE_VAR/logs/*_${LOG_ID}_*.log | awk  -f $WORKSPACE_DIR/lib/duration-stats.awk beginEvent="$BEGIN_EVENT" endEvent="$END_EVENT" > $OUTPUT
fi
