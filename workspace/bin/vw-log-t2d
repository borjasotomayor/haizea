#!/bin/bash

function usage()
{
    echo "Usage: `basename $0` -l log_id [-o output]"
    echo "       `basename $0` -?"
    echo
    echo "      -l log_id       Log identifier (only count events from log files"
    echo "                      with this identifier)"
    echo "      -o output       Print results to file <output>"
    echo "      -t tag          Print results to file <output>"
    echo "      -?              Prints this usage message"
    echo
}



#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~ BASIC SANITY CHECKS ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#

if [ "$WORKSPACE_DIR" == "" ];
then
    echo "WORKSPACE_DIR not set."
    exit 1
fi

if [ "$WORKSPACE_VAR" == "" ];
then
    echo "WORKSPACE_VAR not set."
    exit 1
fi

if [ $# -eq 0 ];
then
    echo "ERROR: No arguments specified!"
    usage
    exit 1
fi

# Error on unset variables
set -u


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ GET OPTIONS ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#

# Defaults
LOG_ID=""
BEGIN_EVENT="TRANSFER_START"
END_EVENT="TRANSFER_END"
OUTPUT=""
TAG=""

# Get options
while getopts ":l:t:o:?" OPTION; do
    case $OPTION in
        l )
            LOG_ID=$OPTARG
        ;;
        o )
            OUTPUT=$OPTARG
        ;;
        t )
            TAG=$OPTARG
        ;;
        \? )
            usage
            exit 1
        ;;
        * )
            echo "ERROR: Unrecognized option"
            exit 1
        ;;
    esac
done

if [ "$LOG_ID" == "" ];
then
    echo "ERROR: No log identifier specified."
    usage
    exit 1
fi

if [ "$OUTPUT" == "" ];
then
    sort $WORKSPACE_VAR/logs/*_${LOG_ID}_*.log | awk  -f $WORKSPACE_DIR/lib/t2d.awk tag="$TAG" beginEvent="$BEGIN_EVENT" endEvent="$END_EVENT"
else
    sort $WORKSPACE_VAR/logs/*_${LOG_ID}_*.log | awk  -f $WORKSPACE_DIR/lib/t2d.awk tag="$TAG" beginEvent="$BEGIN_EVENT" endEvent="$END_EVENT" > $OUTPUT
fi
