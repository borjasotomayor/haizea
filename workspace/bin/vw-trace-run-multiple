#!/bin/bash

function usage()
{
    echo "Usage: `basename $0` -f exp_file [-m email] [-r] <timestamp> [-o]"
    echo "       `basename $0` -?"
    echo
    echo "      -f exp_file     Experiment file to use"
    echo "      -m email        Send an e-mail report with experiment log to <email>"
    echo "      -h <path>       Generate HTML report and upload to <path>"
    echo "      -r <timestamp>  Don't run, just re-generate reports (graphs + html)"
    echo "	                for given <timestamp>"
    echo "      -t <timestamp>  Force usage of given <timestamp>"
    echo "      -o              Don't run, write script to standard output"
    echo "      -?              Prints this usage message"
    echo
}



#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~ BASIC SANITY CHECKS ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#

if [ "$WORKSPACE_DIR" == "" ];
then
    echo "WORKSPACE_DIR not set."
    exit 1
fi

if [ "$WORKSPACE_VAR" == "" ];
then
    echo "WORKSPACE_VAR not set."
    exit 1
fi

if [ $# -eq 0 ];
then
    echo "ERROR: No arguments specified!"
    usage
    exit 1
fi

# Error on unset variables
set -u




#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ GET OPTIONS ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#

# Defaults
EXP_FILE=""
EMAIL=""
RUN=true
TIMESTAMP=""
FORCETIMESTAMP=""
UPLOAD=""

# Get options
while getopts ":or:h:t:f:m:?" OPTION; do
    case $OPTION in
        f )
            EXP_FILE=$OPTARG
        ;;
        m )
            EMAIL=$OPTARG
        ;;
        o )
            RUN=false
        ;;
        r )
            TIMESTAMP=$OPTARG
        ;;
        t )
            FORCETIMESTAMP=$OPTARG
        ;;
        h )
            UPLOAD=$OPTARG
        ;;
        \? )
            usage
            exit 1
        ;;
        * )
            echo "ERROR: Unrecognized option"
            exit 1
        ;;
    esac
done

if [ "$EXP_FILE" == "" ];
then
    echo "ERROR: No trace file specified."
    usage
    exit 1
fi

if $RUN;
then
    awk -f $WORKSPACE_DIR/lib/expfile_functions.awk -f $WORKSPACE_DIR/lib/expfile2sh.awk -v forcetimestamp="$FORCETIMESTAMP" -v timestamp="$TIMESTAMP" $EXP_FILE > $EXP_FILE.sh
    chmod u+x $EXP_FILE.sh
    ./$EXP_FILE.sh 2>&1 | tee -i $EXP_FILE.log
    rm $EXP_FILE.sh
else
    awk -f $WORKSPACE_DIR/lib/expfile_functions.awk -f $WORKSPACE_DIR/lib/expfile2sh.awk -v forcetimestamp="$FORCETIMESTAMP" -v timestamp="$TIMESTAMP" $EXP_FILE 
fi

if $RUN;
then
    if [ "$UPLOAD" != "" ];
    then
        echo "Preparing HTML report"
        HTML_DIR="/tmp/$(date +%s)"
        if [ "$TIMESTAMP" == "" ];
        then
            TIMESTAMP=`cat timestamp`
        fi
        mkdir $HTML_DIR
        mkdir $HTML_DIR/traces
        awk -f $WORKSPACE_DIR/lib/expfile_functions.awk -f $WORKSPACE_DIR/lib/expfile2xml.awk -v timestamp="$TIMESTAMP" $EXP_FILE > $HTML_DIR/results.xml
        xsltproc $WORKSPACE_DIR/lib/experiments.xsl $HTML_DIR/results.xml > $HTML_DIR/index.html.tmp
	grep -v "<?xml" $HTML_DIR/index.html.tmp > $HTML_DIR/index.html
        cp $WORKSPACE_DIR/lib/experiments.css $HTML_DIR
        cp -r $WORKSPACE_VAR/graphs/$TIMESTAMP $HTML_DIR
        TRACES=$(grep "using trace" $EXP_FILE | cut -f3 -d" ")
        for TRACE in $TRACES;
        do
            vw-trace-stats -t $WORKSPACE_DIR/traces/$TRACE > $WORKSPACE_DIR/traces/$TRACE.stats
            cp $WORKSPACE_DIR/traces/$TRACE $HTML_DIR/traces
            cp $WORKSPACE_DIR/traces/$TRACE.conf $HTML_DIR/traces
            cp $WORKSPACE_DIR/traces/$TRACE.stats $HTML_DIR/traces
        done
        
        scp -r $HTML_DIR $UPLOAD
        echo "HTML report uploaded"
    fi
    
    if [ "$EMAIL" != "" ];
    then
        mail -s "Results of running experiment file '$EXP_FILE'" $EMAIL < $EXP_FILE.log
        echo "Sent experiment log to $EMAIL"
    fi
fi



