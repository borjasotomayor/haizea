#!/bin/bash

# Mock VM startup script
# Not meant to be invoked directly

function usage()
{
    echo "Usage: `basename $0` -i imagefile [-l log_id]"
    echo "       `basename $0` -?"
    echo
    echo "	-l log_id       Log identifier (determines name of log files)"
    echo "	                Default is 'TEST'"
    echo "	-i imagefile    VM image to use (currently only used to verify"
    echo "	                if the image is actually there)"
    echo "	-?              Prints this usage message"
    echo
}



#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~ BASIC SANITY CHECKS ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#

if [ "$WORKSPACE_DIR" == "" ];
then
    echo "WORKSPACE_DIR not set."
    exit 1
fi

if [ "$WORKSPACE_VAR" == "" ];
then
    echo "WORKSPACE_VAR not set."
    exit 1
fi

if [ "$JOB_ID" == "" ];
then
    JOB_ID=0
fi

if [ "$SGE_TASK_ID" == "" ];
then
    SGE_TASK_ID=0
fi

if [ "$JOB_NAME" == "" ];
then
    JOB_NAME="NULL"
fi

if [ $# -eq 0 ];
then
    echo "ERROR: No arguments specified!"
    usage
    exit 1
fi

source "$WORKSPACE_DIR/bin/common.sh"

# Error on unset variables
set -u




#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ GET OPTIONS ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#

# Defaults
LOG_ID="TEST"
TAG="NULL"

# Get options
while getopts ":l:i:?" OPTION; do
    case $OPTION in
	l ) 
	    LOG_ID=$OPTARG
	;;
	i ) 
	    IMAGE=$OPTARG
	;;
	\? ) 
	    usage
	    exit 1
	;;
	* ) 
	    echo "ERROR: Unrecognized option"
	    exit 1
	;;
    esac
done



#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~ MAIN CODE BEGINS HERE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#

ERROR=0

log "--VMEND_START--"
if [ -f $LOCALIMG_DIR/$IMAGE ];
then
    log "Removing $LOCALIMG_DIR/$IMAGE"
    rm $LOCALIMG_DIR/$IMAGE
else
    log "ERROR: $LOCALIMG_DIR/$IMAGE does not exist"
fi
log "--VMEND_END--"
